<!DOCTYPE html>
<html>
  <head> 
    <title>Data</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script
			src="https://code.jquery.com/jquery-3.5.1.min.js"
			integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			crossorigin="anonymous"></script>
      <style type="text/css">
         body {
  background-image: url('https://img.rawpixel.com/s3fs-private/rawpixel_images/website_content/pf-misctexture01-beer-032_1.jpg?w=800&dpr=1&fit=default&crop=default&q=65&vib=3&con=3&usm=15&bg=F4F4F3&ixlib=js-2.2.1&s=c5b50a1c0fe30ea91b3c769b294c8e64'); 
  background-size: cover;
  
}
    #bookDataContainer {
        display: flex;
        justify-content: space-around;
        margin-top:50px;

    }
    #danceDataContainer{
       display: flex;
        justify-content: space-around;
        margin-top:50px;
    }
    #otherDataContainer{
     display: flex;
     justify-content: center;
     margin-top:50px;
    }
    button{
          background-color: rgb(173 216 230);
          border: none;
          border-radius: 10px 10px;
          padding: 8px;
          font-size: 15px;
          color: black;
          cursor: pointer;
          margin-right: 20px;
          margin-top: 10px;
    }
    h2{
      background-color: rgb(173 216 230);
      width: 15%;
      border-radius: 10px;
      margin:auto;
      text-align: center;
    }
      </style>
  </head> 

  <body  onload="loadExistingData()">
    
    <a href="/logout">Sing Out</a>

    <div>
      <h2 >My Book Data</h2>

      <div id="bookDataContainer">Loading...</div>
    </div>
    <div style="clear:left;">
      <br><hr>
      <h2>My Dance Data</h2>
      <div id="danceDataContainer">Loading...</div>
    </div>
    <div style="clear:">
      <br><hr>

      <h2 onclick="toggleOtherData()" style="cursor:pointer;text-decoration:none;">Others' Data</h2>

      <div id="otherDataContainer"> Loading...</div>
    </div>

 <script type="text/javascript">

function deleteData(id) {

    var r = confirm("Are you sure you want to delete the item with the following ID? " + id);
    if (r != true) {
      return;
    }
    let tmp = {
        "id": id
    }

    $.ajax({
        type: 'POST',
        url: "https://cse-120-2021-api-meri.herokuapp.com/data/delete",
        data: tmp,
        cache: false,
        dataType : 'json',
        success: function (data) {
            console.log("success");
            window.location.reload();

        },
        error: function (xhr) {
            console.error("Error in post", xhr);
        },
        complete: function () {
            console.log("Complete");  
        }
    });
}

function loadExistingData() {
  myBookData = [];
  myDanceData = [];
  otherData = [];
  
    $.ajax({
        type : "GET",
        url : "https://cse-120-2021-api-meri.herokuapp.com/data",
        dataType : "json",
        success : function(data) {
          loadedData = data.data;
          console.log("success", data);
            data.data.forEach(elem => {
          if (elem["owner"] == "MeriMadanyan") {
            if (elem["project"] == "Book") {
              myBookData.push(elem);
            } else {
              myDanceData.push(elem);
            }
          } else {
            otherData.push(elem);
          }
        })
        displayData(myBookData, "bookDataContainer");
        displayData(myDanceData, "danceDataContainer");
        displayData(otherData, "otherDataContainer");
      },
        error : function(data) {
            console.log("Error");
        }
    });
}
function displayData(data, containerDivName) {
    document.getElementById(containerDivName).innerHTML = "";
    data.forEach(elem => {
        let item = document.createElement("div");
        item.id = "div" + elem["_id"];
        item.className = "item";
        if (Object.keys(elem).length == 1) {
            let span = document.createElement("span");
            //span.innerHTML = "<i>Empty Element with autogenerated ID: </i>" + elem["_id"];
            item.appendChild(span);
        }
        Object.keys(elem).forEach(key => {
            if (key != "_id") {
                let span = document.createElement("span");

                let b = document.createElement("b");
                b.innerHTML = key + ": ";
                span.appendChild(b);
                
                span.className = "item";
                if (elem[key]) {
                    span.innerHTML += elem[key];
                } else {
                    let span1 = document.createElement("span");
                    span1.className = "undefined";
                    span1.innerHTML = "N/A";
                    span.appendChild(span1)
                }
                item.appendChild(span);

                let br = document.createElement("br");
                item.appendChild(br);
            }
        })

        if (elem["owner"] == "MeriMadanyan") {
          let button2 = document.createElement("button");
          button2.innerHTML = "Edit";
          button2.className = "editButton";
          button2.id = "edit_"+ elem["_id"];
          button2.addEventListener("click", function(e){
          editData(e.target.id);
          }, false);
          item.appendChild(button2);
        }

        if (elem["owner"] == "MeriMadanyan" || (elem["fullname"] && elem["fullname"].indexOf("MeriMadanyan") > -1)) {
          let button = document.createElement("button");
          button.innerHTML = "Delete";
          button.id = elem["_id"];
          button.addEventListener("click", function(e){
          deleteData(e.target.id);
          
          }, false);
          item.appendChild(button);
         }
         document.getElementById(containerDivName).appendChild(item);
     
    })

}

function toggleOtherData() {
  let otherData = document.getElementById("otherDataContainer");
  if (otherData.style.display == "block") {
    otherData.style.display = "none";
  } else {
    otherData.style.display = "block";
  }
}

let loadedData = [];

function editData(id){
 var tmp = id.split("edit_");
 var item_id = tmp[1];
 console.log(item_id);

loadedData.forEach(item => {
    if (item._id == item_id && item["owner"] == "MeriMadanyan") {
        console.log(item); 
        localStorage = window.localStorage;
        localStorage.setItem('editItem', JSON.stringify(item));
        if (item["project"] == "Book") {
          document.location  = "editBook"; 
        } else {
          document.location  = "editHobby"; 
        }
    }
  })
}
   
 </script>
</body>
</html>

